<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Go WebSocket Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .message-own {
        background-color: #e3f2fd;
        align-self: flex-end;
      }
      .message-other {
        background-color: #f1f5f9;
        align-self: flex-start;
      }
      .toast {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .toast-hidden {
        opacity: 0;
        transform: translateY(-10px);
      }
      #messages {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .typing-status {
        min-height: 1.5rem; /* Reserve space to prevent layout shift */
      }
      .spinner {
        border: 2px solid #e5e7eb;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        width: 1.5rem;
        height: 1.5rem;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @media (max-width: 640px) {
        #container {
          flex-direction: column;
        }
        #sidebar {
          width: 100%;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans text-gray-800">
    <div class="max-w-5xl mx-auto p-4 sm:p-6">
      <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-center text-blue-600">
        Go WebSocket Chat
      </h1>
      <div
        id="toast"
        class="fixed top-4 right-4 bg-white shadow-lg rounded-lg p-4 max-w-sm toast toast-hidden"
      ></div>
      <div id="container" class="flex flex-col sm:flex-row gap-6">
        <div id="sidebar" class="w-full sm:w-80 bg-white rounded-lg shadow p-4">
          <h2 class="text-lg font-semibold mb-4">User Setup</h2>
          <div class="space-y-3">
            <div>
              <label for="userId" class="block text-sm font-medium"
                >User ID</label
              >
              <input
                id="userId"
                class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., user1"
              />
            </div>
            <div>
              <label for="username" class="block text-sm font-medium"
                >Username</label
              >
              <input
                id="username"
                class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., Alice"
              />
            </div>
            <div class="flex gap-2">
              <button
                id="registerUser"
                onclick="registerUser()"
                class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400"
                title="Enter User ID and Username to register"
              >
                Register
              </button>
              <button
                id="connect"
                onclick="connect()"
                class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400"
                disabled
                title="Register first to connect"
              >
                Connect
              </button>
            </div>
          </div>
          <h2 class="text-lg font-semibold mt-6 mb-4">Online Users</h2>
          <div
            id="online-users"
            class="space-y-2 max-h-40 overflow-y-auto"
            aria-live="polite"
          ></div>
          <h2 class="text-lg font-semibold mt-6 mb-4">Your Groups</h2>
          <div
            id="groups"
            class="space-y-2 max-h-40 overflow-y-auto"
            aria-live="polite"
          ></div>
          <h2 class="text-lg font-semibold mt-6 mb-4">Create Group</h2>
          <div class="space-y-3">
            <div>
              <label for="groupName" class="block text-sm font-medium"
                >Group Name</label
              >
              <input
                id="groupName"
                class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., Friends"
                disabled
                title="Register and connect to create a group"
              />
            </div>
            <button
              id="createGroup"
              onclick="createGroup()"
              class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400"
              disabled
              title="Enter a group name and connect to create"
            >
              Create Group
            </button>
          </div>
        </div>
        <div id="main" class="flex-1 bg-white rounded-lg shadow p-4">
          <div
            id="chat-header"
            class="text-lg font-semibold mb-4 flex items-center"
          >
            <span>Chat</span>
            <span id="chat-context" class="ml-2 text-blue-600"></span>
            <span id="loading" class="ml-2 hidden spinner"></span>
          </div>
          <div class="mb-4">
            <label for="targetId" class="block text-sm font-medium"
              >Chat With (User/Group ID)</label
            >
            <div class="flex items-center gap-2">
              <input
                id="targetId"
                class="flex-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., user2 or group1"
                disabled
                title="Register and connect to select a chat"
              />
              <label class="flex items-center gap-1">
                <input
                  type="checkbox"
                  id="isGroup"
                  class="h-4 w-4"
                  disabled
                  title="Register and connect to enable group chat"
                />
                <span>Group Chat</span>
              </label>
            </div>
          </div>
          <div
            id="group-management"
            class="mb-4 hidden transition-all duration-300"
          >
            <h3 class="text-md font-semibold mb-2">Group Management</h3>
            <div class="flex gap-2 mb-2">
              <input
                id="addMemberId"
                class="flex-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="User ID"
                disabled
                title="Select a group to add members"
              />
              <button
                id="addMember"
                onclick="addMember()"
                class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400"
                disabled
                title="Enter a user ID to add"
              >
                Add
              </button>
            </div>
            <div class="text-sm font-medium mb-2">Group Members</div>
            <div
              id="group-members"
              class="space-y-2 max-h-40 overflow-y-auto"
              aria-live="polite"
            ></div>
          </div>
          <div
            id="typing-status"
            class="text-sm text-gray-500 italic mb-2 typing-status"
            aria-live="polite"
          ></div>
          <div
            id="messages"
            class="h-96 overflow-y-auto p-4 border rounded bg-gray-50 mb-4"
            role="log"
            aria-live="polite"
          ></div>
          <div class="flex gap-2">
            <input
              id="messageInput"
              class="flex-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Type a message..."
              oninput="sendTyping()"
              disabled
              title="Select a chat to send messages"
            />
            <button
              id="sendMessage"
              onclick="sendMessage()"
              class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400"
              disabled
              title="Type a message to send"
            >
              Send
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let socket;
      let userId, username, targetId;
      let currentGroup = null;
      let displayedMessages = new Set();
      let isTypingSent = false;
      let isRegistered = false;
      let isConnected = false;
      let typingTimeout = null;
      let currentChatName = "";

      // Debounce function for typing
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Toast notification
      function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = `fixed top-4 right-4 bg-white shadow-lg rounded-lg p-4 max-w-sm toast ${
          isError ? "border-l-4 border-red-500" : "border-l-4 border-green-500"
        }`;
        setTimeout(() => {
          toast.className =
            "fixed top-4 right-4 bg-white shadow-lg rounded-lg p-4 max-w-sm toast toast-hidden";
        }, 3000);
      }

      // Update UI state
      function updateUIState() {
        document.getElementById("userId").disabled = isRegistered;
        document.getElementById("username").disabled = isRegistered;
        document.getElementById("registerUser").disabled =
          isRegistered ||
          !document.getElementById("userId").value.trim() ||
          !document.getElementById("username").value.trim();
        document.getElementById("connect").disabled =
          !isRegistered || isConnected;
        document.getElementById("groupName").disabled =
          !isRegistered || !isConnected;
        document.getElementById("createGroup").disabled =
          !isRegistered ||
          !isConnected ||
          !document.getElementById("groupName").value.trim();
        document.getElementById("targetId").disabled =
          !isRegistered || !isConnected;
        document.getElementById("isGroup").disabled =
          !isRegistered || !isConnected;
        document.getElementById("messageInput").disabled =
          !isRegistered ||
          !isConnected ||
          !document.getElementById("targetId").value.trim();
        document.getElementById("sendMessage").disabled =
          !isRegistered ||
          !isConnected ||
          !document.getElementById("targetId").value.trim() ||
          !document.getElementById("messageInput").value.trim();
        document.getElementById("addMemberId").disabled =
          !isRegistered || !isConnected || !currentGroup;
        document.getElementById("addMember").disabled =
          !isRegistered ||
          !isConnected ||
          !currentGroup ||
          !document.getElementById("addMemberId").value.trim();
      }

      // Update inputs on change
      document
        .getElementById("userId")
        .addEventListener("input", updateUIState);
      document
        .getElementById("username")
        .addEventListener("input", updateUIState);
      document
        .getElementById("groupName")
        .addEventListener("input", updateUIState);
      document
        .getElementById("targetId")
        .addEventListener("input", updateUIState);
      document
        .getElementById("messageInput")
        .addEventListener("input", updateUIState);
      document
        .getElementById("addMemberId")
        .addEventListener("input", updateUIState);

      async function registerUser() {
        userId = document.getElementById("userId").value.trim();
        username = document.getElementById("username").value.trim();
        if (!userId || !username)
          return showToast("Enter user ID and username", true);

        try {
          const res = await fetch("http://localhost:8080/users", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: userId, username }),
          });
          if (!res.ok)
            throw new Error((await res.json()).error || "Failed to register");
          isRegistered = true;
          updateUIState();
          showToast("Registered successfully");
          updateGroups();
        } catch (err) {
          showToast(`Error: ${err.message}`, true);
        }
      }

      async function connect() {
        userId = document.getElementById("userId").value.trim();
        if (!userId) return showToast("Enter your user ID", true);

        if (socket) socket.close();
        socket = new WebSocket(`ws://localhost:8080/ws?id=${userId}`);

        socket.onopen = () => {
          isConnected = true;
          updateUIState();
          showToast("Connected");
          updateOnlineUsers();
          updateGroups();
          sendTyping();
        };

        socket.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          console.log("Received:", msg);

          if (msg.type === "message") {
            if (!displayedMessages.has(msg.id)) {
              displayedMessages.add(msg.id);
              appendMessage(
                `[${msg.sender_id}] ${msg.content}`,
                msg.id,
                msg.sender_id === userId ? "message-own" : "message-other"
              );
            }
          } else if (msg.type === "typing") {
            showTyping(msg.sender_id, msg.status === "start");
          } else if (msg.type === "status") {
            appendMessage(
              `[STATUS] ${msg.sender_id} is ${msg.status}`,
              "",
              "text-gray-500"
            );
            updateOnlineUsers();
          } else if (msg.type === "group_update") {
            const { type, data } = msg.data;
            appendMessage(
              `[GROUP] ${type}: ${JSON.stringify(data)}`,
              "",
              "text-green-600"
            );
            if (msg.group_id === currentGroup) updateGroupMembers();
            updateGroups();
          }
        };

        socket.onclose = () => {
          isConnected = false;
          updateUIState();
          showToast("Disconnected, reconnecting...");
          document.getElementById("group-management").classList.add("hidden");
          document.getElementById("loading").classList.remove("hidden");
          setTimeout(connect, 3000);
        };

        socket.onerror = () => {
          showToast("WebSocket error", true);
        };
      }

      async function createGroup() {
        const groupName = document.getElementById("groupName").value.trim();
        if (!groupName || !userId)
          return showToast("Enter group name and ensure registered", true);

        try {
          document.getElementById("createGroup").disabled = true;
          const res = await fetch("http://localhost:8080/groups", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: groupName, owner_id: userId }),
          });
          if (!res.ok)
            throw new Error(
              (await res.json()).error || "Failed to create group"
            );
          const group = await res.json();
          appendMessage(
            `[GROUP] Created group ${group.name} (${group.id})`,
            "",
            "text-green-600"
          );
          updateGroups();
          document.getElementById("groupName").value = "";
          showToast("Group created");
        } catch (err) {
          showToast(`Error: ${err.message}`, true);
        } finally {
          document.getElementById("createGroup").disabled = false;
          updateUIState();
        }
      }

      async function updateOnlineUsers() {
        try {
          const res = await fetch("http://localhost:8080/users/online");
          const users = await res.json();
          const el = document.getElementById("online-users");
          el.innerHTML = users
            .map(
              (u) => `
            <div class="flex items-center justify-between p-2 hover:bg-gray-100 rounded">
              <span>${u.username} (${u.id})</span>
              <button onclick="startChat('${u.id}', false)" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Chat</button>
            </div>
          `
            )
            .join("");
        } catch (err) {
          showToast(`Error fetching online users: ${err.message}`, true);
        }
      }

      async function updateGroups() {
        if (!userId) return;
        try {
          const res = await fetch(
            `http://localhost:8080/users/${userId}/groups`
          );
          const groups = await res.json();
          const el = document.getElementById("groups");
          el.innerHTML = groups
            .map(
              (g) => `
            <div class="flex items-center justify-between p-2 hover:bg-gray-100 rounded">
              <span>${g.name} (${g.id})</span>
              <button onclick="joinGroup('${g.id}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Chat</button>
            </div>
          `
            )
            .join("");
        } catch (err) {
          showToast(`Error fetching groups: ${err.message}`, true);
        }
      }

      async function joinGroup(groupId) {
        currentGroup = groupId;
        document.getElementById("targetId").value = groupId;
        document.getElementById("isGroup").checked = true;
        document.getElementById("group-management").classList.remove("hidden");
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(
            JSON.stringify({
              type: "join_group",
              sender_id: userId,
              group_id: groupId,
            })
          );
        }
        appendMessage(`[GROUP] Joined group ${groupId}`, "", "text-green-600");
        await updateGroupMembers();
        await loadMessageHistory(groupId, true);
        updateChatHeader(groupId, true);
        sendTyping();
      }

      async function updateGroupMembers() {
        if (!currentGroup) return;
        try {
          const res = await fetch(
            `http://localhost:8080/groups/${currentGroup}`
          );
          const group = await res.json();
          const isOwner = group.owner_id === userId;
          const isAdmin = group.admins.includes(userId);

          const memberDetails = await Promise.all(
            group.members.map(async (memberId) => {
              try {
                const userRes = await fetch(
                  `http://localhost:8080/users/${memberId}`
                );
                if (!userRes.ok) return { id: memberId, username: memberId };
                const user = await userRes.json();
                return { id: memberId, username: user.username || memberId };
              } catch {
                return { id: memberId, username: memberId };
              }
            })
          );

          const el = document.getElementById("group-members");
          el.innerHTML = memberDetails
            .map(
              (member) => `
            <div class="flex items-center justify-between p-2 hover:bg-gray-100 rounded">
              <span>
                ${member.username} (${member.id})
                ${group.admins.includes(member.id) ? " (Admin)" : ""}
                ${member.id === group.owner_id ? " (Owner)" : ""}
              </span>
              <div class="space-x-2">
                ${
                  (isOwner || isAdmin) && member.id !== userId
                    ? `
                  <button onclick="kickMember('${member.id}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">Kick</button>
                `
                    : ""
                }
                ${
                  isOwner && member.id !== userId
                    ? `
                  ${
                    group.admins.includes(member.id)
                      ? `<button onclick="removeAdmin('${member.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500">Remove Admin</button>`
                      : `<button onclick="addAdmin('${member.id}')" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">Make Admin</button>`
                  }
                `
                    : ""
                }
              </div>
            </div>
          `
            )
            .join("");
        } catch (err) {
          showToast(`Error fetching group members: ${err.message}`, true);
        }
      }

      async function addMember() {
        const memberId = document.getElementById("addMemberId").value.trim();
        if (!currentGroup || !memberId)
          return showToast("Enter a user ID and select a group", true);

        try {
          const userRes = await fetch(
            `http://localhost:8080/users/${memberId}`
          );
          if (!userRes.ok) throw new Error("User not found");
          const res = await fetch(
            `http://localhost:8080/groups/${currentGroup}/members`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: memberId, requester_id: userId }),
            }
          );
          if (!res.ok)
            throw new Error((await res.json()).error || "Failed to add member");
          appendMessage(
            `[GROUP] Added ${memberId} to group`,
            "",
            "text-green-600"
          );
          updateGroupMembers();
          document.getElementById("addMemberId").value = "";
          showToast("Member added");
        } catch (err) {
          showToast(`Error: ${err.message}`, true);
        }
      }

      async function kickMember(memberId) {
        try {
          const res = await fetch(
            `http://localhost:8080/groups/${currentGroup}/members/${memberId}?requester_id=${userId}`,
            { method: "DELETE" }
          );
          if (!res.ok)
            throw new Error(
              (await res.json()).error || "Failed to kick member"
            );
          appendMessage(
            `[GROUP] Kicked ${memberId} from group`,
            "",
            "text-green-600"
          );
          updateGroupMembers();
          showToast("Member kicked");
        } catch (err) {
          showToast(`Error: ${err.message}`, true);
        }
      }

      async function addAdmin(memberId) {
        try {
          const res = await fetch(
            `http://localhost:8080/groups/${currentGroup}/admins/${memberId}?requester_id=${userId}`,
            { method: "PUT" }
          );
          if (!res.ok)
            throw new Error((await res.json()).error || "Failed to add admin");
          appendMessage(
            `[GROUP] Made ${memberId} an admin`,
            "",
            "text-green-600"
          );
          updateGroupMembers();
          showToast("Admin added");
        } catch (err) {
          showToast(`Error: ${err.message}`, true);
        }
      }

      async function removeAdmin(memberId) {
        try {
          const res = await fetch(
            `http://localhost:8080/groups/${currentGroup}/admins/${memberId}?requester_id=${userId}`,
            { method: "DELETE" }
          );
          if (!res.ok)
            throw new Error(
              (await res.json()).error || "Failed to remove admin"
            );
          appendMessage(
            `[GROUP] Removed ${memberId} as admin`,
            "",
            "text-green-600"
          );
          updateGroupMembers();
          showToast("Admin removed");
        } catch (err) {
          showToast(`Error: ${err.message}`, true);
        }
      }

      async function loadMessageHistory(id, isGroup) {
        try {
          document.getElementById("loading").classList.remove("hidden");
          const url = isGroup
            ? `http://localhost:8080/groups/${id}/messages`
            : `http://localhost:8080/users/${userId}/messages/${id}`;
          const res = await fetch(url);
          if (!res.ok)
            throw new Error(
              (await res.json()).error || "Failed to load messages"
            );
          const messages = await res.json();
          const div = document.getElementById("messages");
          div.innerHTML = "";
          displayedMessages.clear();
          messages.forEach((msg) => {
            if (!displayedMessages.has(msg.id)) {
              displayedMessages.add(msg.id);
              appendMessage(
                `[${msg.sender_id}] ${msg.content}`,
                msg.id,
                msg.sender_id === userId ? "message-own" : "message-other"
              );
            }
          });
        } catch (err) {
          showToast(`Error loading messages: ${err.message}`, true);
        } finally {
          document.getElementById("loading").classList.add("hidden");
        }
      }

      async function updateChatHeader(id, isGroup) {
        try {
          if (isGroup) {
            const res = await fetch(`http://localhost:8080/groups/${id}`);
            const group = await res.json();
            currentChatName = group.name;
            document.getElementById(
              "chat-context"
            ).textContent = `with ${group.name} (Group)`;
          } else {
            const res = await fetch(`http://localhost:8080/users/${id}`);
            const user = await res.json();
            currentChatName = user.username;
            document.getElementById(
              "chat-context"
            ).textContent = `with ${user.username}`;
          }
        } catch (err) {
          document.getElementById("chat-context").textContent = `with ${id}`;
          currentChatName = id;
        }
      }

      async function startChat(id, isGroup) {
        document.getElementById("targetId").value = id;
        document.getElementById("isGroup").checked = isGroup;
        document
          .getElementById("group-management")
          .classList.toggle("hidden", !isGroup);
        currentGroup = isGroup ? id : null;
        if (isGroup) {
          await joinGroup(id);
        } else {
          await updateChatHeader(id, false);
          await loadMessageHistory(id, false);
        }
        sendTyping();
        updateUIState();
      }

      function sendMessage() {
        const content = document.getElementById("messageInput").value.trim();
        if (!content || !socket || socket.readyState !== WebSocket.OPEN) {
          showToast(
            "Cannot send message: Not connected or empty message",
            true
          );
          return;
        }

        const isGroup = document.getElementById("isGroup").checked;
        targetId = document.getElementById("targetId").value.trim();
        if (!targetId) {
          showToast("Please specify a user or group to chat with", true);
          return;
        }

        const messageId = crypto.randomUUID();
        const message = {
          type: "message",
          sender_id: userId,
          [isGroup ? "group_id" : "receiver_id"]: targetId,
          content,
          id: messageId,
        };

        socket.send(JSON.stringify(message));
        if (!displayedMessages.has(messageId)) {
          displayedMessages.add(messageId);
          appendMessage(`[${userId}] ${content}`, messageId, "message-own");
        }
        document.getElementById("messageInput").value = "";
        sendTyping();
        updateUIState();
      }

      const debouncedSendTyping = debounce(() => {
        if (!socket || socket.readyState !== WebSocket.OPEN || !userId) return;
        targetId = document.getElementById("targetId").value.trim();
        if (!targetId) return;

        const content = document.getElementById("messageInput").value.trim();
        const shouldBeTyping = content.length > 0;

        if (shouldBeTyping && !isTypingSent) {
          socket.send(
            JSON.stringify({
              type: "typing",
              sender_id: userId,
              [document.getElementById("isGroup").checked
                ? "group_id"
                : "receiver_id"]: targetId,
              status: "start",
            })
          );
          isTypingSent = true;
        } else if (!shouldBeTyping && isTypingSent) {
          socket.send(
            JSON.stringify({
              type: "typing",
              sender_id: userId,
              [document.getElementById("isGroup").checked
                ? "group_id"
                : "receiver_id"]: targetId,
              status: "stop",
            })
          );
          isTypingSent = false;
        }
      }, 300);

      function sendTyping() {
        debouncedSendTyping();
      }

      function appendMessage(msg, messageId = "", className = "") {
        const div = document.getElementById("messages");
        const el = document.createElement("div");
        el.className = `p-2 rounded max-w-[80%] ${className}`;
        el.textContent = msg;
        if (messageId) el.dataset.messageId = messageId;
        div.appendChild(el);
        div.scrollTop = div.scrollHeight;
      }

      function showTyping(user, isTyping) {
        const typingStatus = document.getElementById("typing-status");
        if (user === userId) return; // Don't show own typing
        if (isTyping) {
          typingStatus.textContent = `${user} is typing...`;
        } else {
          typingStatus.textContent = "";
        }
      }

      // Keyboard accessibility
      document.addEventListener("keydown", (e) => {
        if (
          e.key === "Enter" &&
          document.activeElement === document.getElementById("messageInput")
        ) {
          sendMessage();
        }
        if (
          e.key === "Enter" &&
          document.activeElement === document.getElementById("userId") &&
          !isRegistered
        ) {
          registerUser();
        }
        if (
          e.key === "Enter" &&
          document.activeElement === document.getElementById("groupName")
        ) {
          createGroup();
        }
        if (
          e.key === "Enter" &&
          document.activeElement === document.getElementById("addMemberId")
        ) {
          addMember();
        }
      });

      // Initialize UI state and show welcome message
      updateUIState();
      showToast("Welcome! Enter a User ID and Username to register.", false);
    </script>
  </body>
</html>
